<div id="sidebar_container" class="hidden">
	<div id="sidebar" class="floatable">
		<div id="sidebar_header"></div>
		<div id="sidebar_navi"></div>
	</div>
</div>
<div id="article_container">
	<div id="location_container" class="hidden">
		<div id="location">
			<div id="loc_prompt"></div>
			<div id="loc_entry_1"></div>
			<div id="loc_sep_1"></div>
			<div id="loc_entry_2"></div>
			<div id="loc_sep_2"></div>
			<div id="loc_entry_3"></div>
		</div>
	</div>
	<div id="placeholder" class="hidden"></div>
</div>
<script>
	var page_404 = '<p style="text-align:center;text-indent:0"><img style="display:inline" src="images/404.jpg"></p>';

	String.prototype.format = String.prototype.f = function() {
		var s = this,
			i = arguments.length;
		while(i--) {
			s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
		}
		return s;
	};

	function renderPageButton(current_page, page_count, link_script) {
		if(page_count < 2) return;
		if(current_page == 1) {
			$('#pager').append('<div class="pagebutton pagebutton_disabled">&lt;</div>');
		} else {
			$('#pager').append('<div class="pagebutton"><a href="' + link_script(current_page - 1) + '">&lt;</a></div>');
		}
		for(var i = 1; i <= page_count; i++) {
			if(i == current_page) {
				$('#pager').append('<div class="pagebutton nowpage"><a href="' + link_script(i) + '">' + i + '</a></div>');
			} else {
				$('#pager').append('<div class="pagebutton"><a href="' + link_script(i) + '">' + i + '</a></div>');
			}
		}
		if(current_page == page_count) {
			$('#pager').append('<div class="pagebutton pagebutton_disabled">&gt;</div>');
		} else {
			$('#pager').append('<div class="pagebutton"><a href="' + link_script(current_page + 1) + '">&gt;</a></div>');
		}
	}

	function countPage(length, num_per_page) {
		return Math.floor((length - 1) / num_per_page) + 1;
	}

	function renderGrid(tag, lang, section, column, page) {
		$.getJSON('content_' + lang + '/' + section + '/' + column + '/0.json', function(data) {
			var page_count = countPage(data.length, 3 * 4);
			if(isNaN(page) || page < 1 || page > page_count) page = 1;
			$(tag).html(
				'<div class="gridcont"></div>' +
				'<div id="pager_container"><div id="pager"></div></div>');
			var start = (p - 1) * 12, end = p * 12;
			if(end > data.length) end = data.length;
			var grid = [
				'<div class="grid">',
					'<div class="grid-image">',
						'<img src="{0}">',
					'</div>',
					'<div class="grid-link">',
						'<a href="{1}">{2}</a>',
					'</div>',
				'</div>'
			].join('\n');
			for(var i = start; i < end; i++) {
				if(typeof data[i].url == 'string') {
					$('.gridcont').append(grid.f(
						data[i].image,
						data[i].url,
						data[i].title));
				} else {
					$('.gridcont').append(grid.f(
						data.grids[i].image,
						'?s=' + section + '&amp;c=' + column + '&amp;a=' + data[i].url,
						data.grids[i].title));
				}
			}
				renderPageButton(page, page_count, function(page) {
					return "javascript:renderGrid('" + tag + "','" + lang + "'," + section + "," + column + "," + page + ")";
				});
		});
	}

	function renderList(tag, lang, section, column, page) {
		$.getJSON('content_' + lang + '/' + section + '/' + column + '/0.json', function(data) {
			var page_count = countPage(data.length, 15);
			if(isNaN(page) || page < 1 || page > page_count) page = 1;
			$(tag).html('<table id="newslist"></table><div id="pager_container"><div id="pager"></div></div>');
			var start = (page - 1) * 15, end = page * 15;
			if(end > data.length) end = data.length;
			for(var i = start; i < end; i++) {
				if(typeof data[i].url == 'string') {
					$('#newslist').append('<tr><td class="newsdot"></td><td class="newstitle"><a href="' + data[i].url +
						'">' + data[i].title + '</a></td>' + ((data[i].date) ? '<td class="newsdate">' + data[i].date +
						'</td>' : '') + '</tr>');
				} else {
					$('#newslist').append('<tr><td class="newsdot"></td><td class="newstitle"><a href="?s=' + section +
						'&amp;c=' + column + '&amp;a=' + data[i].url + '">' + data[i].title + '</a></td>' + ((data[i].date) ?
						'<td class="newsdate">' + data[i].date + '</td>' : '') + '</tr>');
				}
			}
			renderPageButton(page, page_count, function(page) {
				return "javascript:renderList('" + tag + "','" + lang + "'," + section + "," + column + "," + page + ")";
			});
		});
	}

	function renderContent(data, sequence, section, column, page, article, lang, animating, animation, norefresh) {
		var site_title = data[0].title;
		$('#loc_prompt').text(data[0].loc_prompt);
		if (section < 1 || section >= data.length) {
			document.title = '404 - ' + site_title;
			$('#loc_entry_1').text('404');
			$('#placeholder').html(page_404);
		} else {
			$('#loc_sep_1').show();
			data = data[section];
			$('#loc_entry_1').text(data[0].page_name);
			if(isNaN(column) || column < 1 || column >= data.length) column = 1;
			document.title = data[column].name + ' - ' + site_title;
			$('#sidebar_header').text(data[0].page_name);
			$('#sidebar_navi').html('<ul></ul>');
			for(var s = 1; s < data.length; s++) {
				if(s == column) {
					$('#sidebar_navi ul').append('<li><a href="?s=' + section + '&amp;c=' + s + '"><strong>' + data[s].name + '</strong></a></li>');
				} else {
					$('#sidebar_navi ul').append('<li><a href="?s=' + section + '&amp;c=' + s + '">' + data[s].name + '</a></li>');
				}
			}
			if(isNaN(article)) {
				$('#loc_entry_2').text(data[column].name);
				switch (data[column].type) {
				case 0:
					$.getJSON('content_' + lang + '/' + section + '/' + column + '.json', function(data) {
						$('#placeholder').html(data.html);
					}).fail(function() {
						$('#loc_entry_2').text('404');
						$('#placeholder').html(page_404);
					});
					break;
				case 1:
					renderList('#placeholder', lang, section, column, page);
					break;
				case 2:
					renderGrid('#placeholder', lang, section, column, page);
					break;
				default:
					$('#placeholder').html(page_404);
				}
			} else {
				$('#loc_entry_2').html('<a href="?s=' + section + '&amp;c=' + column + '">' + data[column].name + '</a>');
				$('#loc_sep_2').show();
				$.getJSON('content_' + lang + '/' + section + '/' + column + '/' + article + '.json', function(data) {
					$('#placeholder').append('<div class="article_title">' + data.title + '</div>');
					if(data.date) $('#placeholder').append('<div class="article_date">' + data.date + '</div>');
					$('#placeholder').append('<div class="article_content">' + data.html + '</div>');
					var title_node = $('#placeholder .article_title');
					if(title_node.length != 0) {
						var title = title_node.text();
						document.title = title + ' - ' + site_title;
					} else {
						var title = a;
					}
					$('#loc_entry_3').text(title);
				}).fail(function() {
					$('#loc_entry_3').text('404');
					$('#placeholder').html(page_404);
				});
			}
		}
		if(animating) {
			for(var i = 1; i < 8; i++) sequence[i] = new $.Deferred();
			sequence[0].done(function() {
				$('#location_container').bind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd', function() {
					$('#location_container').unbind();
					sequence[1].resolve();
				});
				$('#location_container').removeClass('hidden');
			});
			sequence[1].done(function() {
				$('#sidebar_container').bind('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd', function() {
					$('#sidebar_container').unbind();
					sequence[2].resolve();
				});
				$('#sidebar_container').removeClass('hidden');
			});
			sequence[2].done(function() {
				$('#placeholder').removeClass('hidden');
			});
		} else {
			$('.hidden').removeClass('hidden');
		}
	}
</script>
